<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>부실징후 예측 대시보드 (TS2000 · PostgreSQL · FastAPI)</title>
    <meta name="description" content="TS2000 재무데이터 기반 은행 사후관리팀용 조기 경보(EWS) 대시보드 데모" />
    <!-- head 안 -->
    <link rel="stylesheet" href="{{ url_for('static', path='dashboard.css') }}" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
    <script src="{{ url_for('static', path='dashboard.js') }}" defer></script>
</head>
<body>
  {% include "app.html" %}

    <!-- Header -->
    <header role="banner">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div>은행 사후관리팀 EWS 대시보드</div>
          <small>TS2000 재무데이터 · 모델: Logistic/XGBoost (Demo)</small>
        </div>
      </div>
      <div class="spacer"></div>
      <div class="toolbar">
        <input id="search" class="input" type="search" placeholder="기업명 검색" aria-label="기업명 검색" />
        <select id="period" title="기간">
          <option value="8Q" selected>최근 8분기</option>
          <option value="4Q">최근 4분기</option>
          <option value="ALL">전체</option>
        </select>
        <button class="btn ghost" id="refreshBtn">새로고침</button>
        <button class="btn" id="exportBtn">CSV 내보내기</button>
        <button class="btn primary" id="demoToggle">데모데이터 ON</button>
      </div>
    </header>

    <!-- Main -->
    <main role="main">
      <!-- KPIs -->
      <section class="grid kpi-grid" aria-label="핵심 지표">
        <div class="kpi"><h4>전체 기업 수</h4><div class="val" id="kpiTotal">—</div><div class="delta" id="kpiTotalDelta"></div></div>
        <div class="kpi"><h4>High 위험 기업</h4><div class="val" id="kpiHigh">—</div><div class="delta" id="kpiHighDelta"></div></div>
        <div class="kpi"><h4>평균 부실확률</h4><div class="val" id="kpiAvgProb">—</div><div class="delta" id="kpiAvgProbDelta"></div></div>
        <div class="kpi"><h4>평균 이자보상배율</h4><div class="val" id="kpiICR">—</div><div class="delta" id="kpiICRDelta"></div></div>
      </section>

      <!-- Filters bar -->
      <section class="panel" style="margin-top:16px;">
        <div class="panel-header">
          <div class="panel-title">필터</div>
          <div class="toolbar-inline">
            <label class="chip"><input type="checkbox" id="threshICR" checked /> ICR&lt;1 강조</label>
            <label class="chip"><input type="checkbox" id="threshDebt" checked /> 부채비율&gt;400% 강조</label>
            <label class="chip"><input type="checkbox" id="autoRefresh" checked /> 자동 반영</label>
          </div>
        </div>
        <div class="filters">
          <div class="chip">분기: <strong id="currentQuarter">2025Q2</strong></div>
          <div class="chip">표시 행 수:
            <select id="pageSize" style="margin-left:6px;">
              <option>10</option><option selected>25</option><option>50</option><option>100</option>
            </select>
          </div>
          <div class="chip">정렬:
            <select id="sortBy" style="margin-left:6px;">
              <option value="default_prob_desc">부실확률↓</option>
              <option value="icr_asc">이자보상배율↑</option>
              <option value="debt_desc">부채비율↓</option>
              <option value="name_asc">기업명 A→Z</option>
            </select>
          </div>
        </div>
      </section>

      <!-- Charts -->
      {% include "year.html" %}

      <!-- Table -->
      <section class="panel" style="margin-top:16px;">
        <div class="panel-header">
          <div class="panel-title">기업 위험 랭킹</div>
          <div class="toolbar-inline">
            <span class="chip">현재 표: <strong id="tableCount">0</strong>개 기업</span>
            <button class="btn" id="prevPage">이전</button>
            <button class="btn" id="nextPage">다음</button>
          </div>
        </div>
        <div style="overflow:auto; max-height: 50vh;">
          <table aria-label="기업 위험 랭킹 테이블" id="riskTable">
            <thead>
              <tr>
                <th class="rank">#</th>
                <th>기업명</th>
                <th>업종</th>
                <th style="text-align:right;">부채비율(%)</th>
                <th style="text-align:right;">이자보상배율</th>
                <th style="text-align:right;">부실확률(%)</th>
                <th style="text-align:center;">위험등급</th>
              </tr>
            </thead>
            <tbody id="riskTbody">
              <tr><td colspan="7"><div class="skeleton" style="height:48px"></div></td></tr>
              <tr><td colspan="7"><div class="skeleton" style="height:48px"></div></td></tr>
              <tr><td colspan="7"><div class="skeleton" style="height:48px"></div></td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Global News -->
      <section id="globalNews" class="panel" style="margin-top:16px;">
        <div class="panel-header">
          <div class="panel-title">최근 금융/산업 뉴스</div>
        </div>
        <div id="newsTicker" class="ticker">
          <div class="track" id="newsTickerTrack"></div>
        </div>
      </section>


      <!-- Alerts -->
      <section id="alerts" class="panel" style="margin-top:16px;">
        <div class="panel-header"><div class="panel-title">자동 경보 (규칙 기반)</div></div>
        <ul id="alertList" style="margin:0; padding:0 0 0 18px; line-height:1.9"></ul>
      </section>

      <footer style="opacity:.7; margin-top:20px; text-align:center; font-size:12px; color:var(--muted)">
        Demo UI · TS2000 재무데이터 가정치 · FastAPI에서 HTML로 서빙 · 차트는 Chart.js 사용 · © 2025
      </footer>
    </main>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="modal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <header style="display:flex; align-items:center; justify-content:space-between;">
        <div id="modalTitle" style="font-weight:700">기업 상세</div>
        <button class="btn ghost" id="closeModal">닫기</button>
      </header>
      <div class="content">
        <div id="companyMeta" style="display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; margin-bottom:10px"></div>
        <div class="grid" style="grid-template-columns: 1.2fr 1fr; gap:16px;">
          <div class="panel">
            <div class="panel-header"><div class="panel-title">재무지표 추이 (최근 8분기)</div></div>
            <canvas id="detailLine" height="120"></canvas>
          </div>
          <div class="panel">
            <div class="panel-header"><div class="panel-title">모델 점수 변화</div></div>
            <canvas id="detailProb" height="120"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- Toast -->
  <div class="toast" id="toast"></div>
  
</body>
</html>
