<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>부실징후 예측 대시보드 (TS2000 · PostgreSQL · FastAPI)</title>
  <meta name="description" content="TS2000 재무데이터 기반 은행 사후관리팀용 조기 경보(EWS) 대시보드 데모" />
  <style>
    :root {
      --bg: #0b0d12;
      --panel: #11141b;
      --panel-2: #161a22;
      --text: #e7ecf3;
      --muted: #9aa4b2;
      --primary: #4f8cff;
      --success: #22c55e;
      --warn: #f59e0b;
      --danger: #ef4444;
      --border: #1f2430;
      --card: #0f131a;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: linear-gradient(180deg, #090b10 0%, #0c1017 100%);
      color: var(--text);
      font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, "Apple SD Gothic Neo", "Malgun Gothic", Helvetica, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    a { color: var(--primary); text-decoration: none; }
    .app {
      display: grid;
      grid-template-columns: 260px 1fr;
      grid-template-rows: 64px 1fr;
      grid-template-areas:
        "sidebar header"
        "sidebar main";
      height: 100vh;
    }
    /* Header */
    header {
      grid-area: header;
      display: flex; align-items: center; gap: 16px;
      padding: 12px 16px;
      background: linear-gradient(90deg, var(--panel) 0%, var(--panel-2) 100%);
      border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 10;
    }
    .brand { display: flex; align-items: center; gap: 12px; font-weight: 700; }
    .brand .logo {
      width: 28px; height: 28px; display: grid; place-items: center;
      background: radial-gradient(80% 80% at 30% 30%, #5ea2ff 0%, #346bff 50%, #1e3a8a 100%);
      border-radius: 8px; box-shadow: var(--shadow);
    }
    .brand small { color: var(--muted); font-weight: 500; }
    .spacer { flex: 1; }
    .toolbar { display:flex; align-items:center; gap: 8px; }
    .btn {
      background: var(--panel-2);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 12px; border-radius: 10px;
      cursor: pointer; transition: 120ms ease;
    }
    .btn:hover { filter: brightness(1.1); }
    .btn.primary { background: linear-gradient(180deg, #4f8cff, #3b82f6); border-color: #315fcc; }
    .btn.ghost { background: transparent; border-color: var(--border); color: var(--muted); }
    .input, select {
      background: var(--panel-2);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 10px; padding: 8px 10px;
    }
    .input::placeholder { color: #768197; }

    /* Sidebar */
    aside {
      grid-area: sidebar; padding: 12px; border-right: 1px solid var(--border);
      background: linear-gradient(180deg, var(--panel) 0%, #0e1219 100%);
      overflow-y: auto;
    }
    .nav-section { margin-bottom: 18px; }
    .nav-title { font-size: 12px; color: var(--muted); margin: 12px 8px 6px; text-transform: uppercase; letter-spacing: .08em; }
    .nav a {
      display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 10px;
      color: var(--text);
    }
    .nav a:hover { background: var(--panel-2); }
    .nav a.active { background: #101623; border: 1px solid #1f2a3c; }

    /* Main */
    main { grid-area: main; padding: 18px; overflow: auto; }
    .grid { display: grid; gap: 16px; }
    .kpi-grid { grid-template-columns: repeat(4, minmax(220px, 1fr)); }
    .kpi { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 14px; box-shadow: var(--shadow); }
    .kpi h4 { margin: 0 0 8px; font-size: 13px; color: var(--muted); font-weight: 600; }
    .kpi .val { font-size: 24px; font-weight: 800; letter-spacing: -0.02em; }
    .delta { font-size: 12px; margin-left: 8px; }
    .delta.up { color: var(--success); }
    .delta.down { color: var(--danger); }

    .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 14px; box-shadow: var(--shadow); }
    .panel-header { display:flex; align-items:center; justify-content: space-between; margin-bottom: 8px; }
    .panel-title { font-weight: 700; }

    .charts { grid-template-columns: 1.2fr 1fr; }

    /* Filters */
    .filters { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .chip { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius: 999px; border:1px solid var(--border); background: var(--panel-2); font-size:12px; }

    /* Table */
    table { width: 100%; border-collapse: collapse; }
    thead th { text-align:left; font-size:12px; color: var(--muted); padding: 10px; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: var(--panel); }
    tbody td { padding: 12px 10px; border-bottom: 1px solid var(--border); }
    tr:hover td { background: rgba(79,140,255,0.05); }
    .rank { width: 40px; text-align: right; color: var(--muted); }
    .tag { font-size: 11px; padding: 4px 8px; border-radius: 999px; border:1px solid var(--border); }
    .tag.high { background: rgba(239, 68, 68, 0.12); color: #fecaca; border-color: rgba(239,68,68,.3); }
    .tag.medium { background: rgba(245, 158, 11, 0.12); color: #fde68a; border-color: rgba(245,158,11,.3); }
    .tag.low { background: rgba(34, 197, 94, 0.12); color: #bbf7d0; border-color: rgba(34,197,94,.3); }

    .toolbar-inline { display:flex; gap:8px; align-items:center; }

    /* Modal */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.55); display:none; align-items: center; justify-content: center; z-index: 50; }
    .modal { width: min(920px, 92vw); background: var(--panel); border:1px solid var(--border); border-radius: 16px; box-shadow: var(--shadow); overflow: hidden; }
    .modal header { background: var(--panel-2); border-bottom: 1px solid var(--border); padding: 14px; position: unset; }
    .modal .content { padding: 16px; }

    /* Toast */
    .toast { position: fixed; right: 16px; bottom: 16px; display: grid; gap: 8px; z-index: 60; }
    .toast .item { background: var(--panel); border:1px solid var(--border); color: var(--text); padding: 10px 12px; border-radius: 12px; box-shadow: var(--shadow); }

    /* Skeleton */
    .skeleton { background: linear-gradient(90deg, #0e131a 25%, #101722 37%, #0e131a 63%); background-size: 400% 100%; animation: shimmer 1.2s infinite; border-radius: 8px; }
    @keyframes shimmer { 0% { background-position: 100% 0; } 100% { background-position: 0 0; } }

    /* Responsive */
    @media (max-width: 1080px) {
      .kpi-grid { grid-template-columns: repeat(2, 1fr); }
      .charts { grid-template-columns: 1fr; }
      .app { grid-template-columns: 1fr; grid-template-areas: "header" "main"; }
      aside { display:none; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside>
      <div class="brand" style="padding:8px 10px 2px;">
        <div class="logo" aria-hidden="true"></div>
        <div>
          부실징후 예측
          <div style="font-size:12px; color:var(--muted);">EWS · TS2000 · PostgreSQL</div>
        </div>
      </div>
      <nav class="nav">
        <div class="nav-section">
          <div class="nav-title">탐색</div>
          <a href="#" class="active" aria-current="page">📊 개요 / Overview</a>
          <a href="#portfolio">📋 포트폴리오</a>
          <a href="#alerts">🚨 경보</a>
          <a href="#cohorts">👥 코호트</a>
          <a href="#settings">⚙️ 설정</a>
        </div>
        <div class="nav-section">
          <div class="nav-title">빠른 필터</div>
          <div style="display:grid; gap:8px;">
            <label class="chip"><input type="checkbox" id="fltHigh" checked /> High 위험만</label>
            <label class="chip"><input type="checkbox" id="fltMed" checked /> Medium 포함</label>
            <label class="chip"><input type="checkbox" id="fltLow" /> Low 제외</label>
          </div>
        </div>
        <div class="nav-section">
          <div class="nav-title">업종</div>
          <div id="industryChips" style="display:flex; flex-wrap:wrap; gap:6px;"></div>
        </div>
      </nav>
    </aside>

    <!-- Header -->
    <header role="banner">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div>은행 사후관리팀 EWS 대시보드</div>
          <small>TS2000 재무데이터 · 모델: Logistic/XGBoost (Demo)</small>
        </div>
      </div>
      <div class="spacer"></div>
      <div class="toolbar">
        <input id="search" class="input" type="search" placeholder="기업명 검색" aria-label="기업명 검색" />
        <select id="period" title="기간">
          <option value="8Q" selected>최근 8분기</option>
          <option value="4Q">최근 4분기</option>
          <option value="ALL">전체</option>
        </select>
        <button class="btn ghost" id="refreshBtn">새로고침</button>
        <button class="btn" id="exportBtn">CSV 내보내기</button>
        <button class="btn primary" id="demoToggle">데모데이터 ON</button>
      </div>
    </header>

    <!-- Main -->
    <main role="main">
      <!-- KPIs -->
      <section class="grid kpi-grid" aria-label="핵심 지표">
        <div class="kpi"><h4>전체 기업 수</h4><div class="val" id="kpiTotal">—</div><div class="delta" id="kpiTotalDelta"></div></div>
        <div class="kpi"><h4>High 위험 기업</h4><div class="val" id="kpiHigh">—</div><div class="delta" id="kpiHighDelta"></div></div>
        <div class="kpi"><h4>평균 부실확률</h4><div class="val" id="kpiAvgProb">—</div><div class="delta" id="kpiAvgProbDelta"></div></div>
        <div class="kpi"><h4>평균 이자보상배율</h4><div class="val" id="kpiICR">—</div><div class="delta" id="kpiICRDelta"></div></div>
      </section>

      <!-- Filters bar -->
      <section class="panel" style="margin-top:16px;">
        <div class="panel-header">
          <div class="panel-title">필터</div>
          <div class="toolbar-inline">
            <label class="chip"><input type="checkbox" id="threshICR" checked /> ICR&lt;1 강조</label>
            <label class="chip"><input type="checkbox" id="threshDebt" checked /> 부채비율&gt;400% 강조</label>
            <label class="chip"><input type="checkbox" id="autoRefresh" checked /> 자동 반영</label>
          </div>
        </div>
        <div class="filters">
          <div class="chip">분기: <strong id="currentQuarter">2025Q2</strong></div>
          <div class="chip">표시 행 수:
            <select id="pageSize" style="margin-left:6px;">
              <option>10</option><option selected>25</option><option>50</option><option>100</option>
            </select>
          </div>
          <div class="chip">정렬:
            <select id="sortBy" style="margin-left:6px;">
              <option value="default_prob_desc">부실확률↓</option>
              <option value="icr_asc">이자보상배율↑</option>
              <option value="debt_desc">부채비율↓</option>
              <option value="name_asc">기업명 A→Z</option>
            </select>
          </div>
        </div>
      </section>

      <!-- Charts -->
      {% include "year.html" %}

      <!-- Table -->
      <section class="panel" style="margin-top:16px;">
        <div class="panel-header">
          <div class="panel-title">기업 위험 랭킹</div>
          <div class="toolbar-inline">
            <span class="chip">현재 표: <strong id="tableCount">0</strong>개 기업</span>
            <button class="btn" id="prevPage">이전</button>
            <button class="btn" id="nextPage">다음</button>
          </div>
        </div>
        <div style="overflow:auto; max-height: 50vh;">
          <table aria-label="기업 위험 랭킹 테이블" id="riskTable">
            <thead>
              <tr>
                <th class="rank">#</th>
                <th>기업명</th>
                <th>업종</th>
                <th style="text-align:right;">부채비율(%)</th>
                <th style="text-align:right;">이자보상배율</th>
                <th style="text-align:right;">부실확률(%)</th>
                <th style="text-align:center;">위험등급</th>
              </tr>
            </thead>
            <tbody id="riskTbody">
              <tr><td colspan="7"><div class="skeleton" style="height:48px"></div></td></tr>
              <tr><td colspan="7"><div class="skeleton" style="height:48px"></div></td></tr>
              <tr><td colspan="7"><div class="skeleton" style="height:48px"></div></td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Alerts -->
      <section id="alerts" class="panel" style="margin-top:16px;">
        <div class="panel-header"><div class="panel-title">자동 경보 (규칙 기반)</div></div>
        <ul id="alertList" style="margin:0; padding:0 0 0 18px; line-height:1.9"></ul>
      </section>

      <footer style="opacity:.7; margin-top:20px; text-align:center; font-size:12px; color:var(--muted)">
        Demo UI · TS2000 재무데이터 가정치 · FastAPI에서 HTML로 서빙 · 차트는 Chart.js 사용 · © 2025
      </footer>
    </main>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="modal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <header style="display:flex; align-items:center; justify-content:space-between;">
        <div id="modalTitle" style="font-weight:700">기업 상세</div>
        <button class="btn ghost" id="closeModal">닫기</button>
      </header>
      <div class="content">
        <div id="companyMeta" style="display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; margin-bottom:10px"></div>
        <div class="grid" style="grid-template-columns: 1.2fr 1fr; gap:16px;">
          <div class="panel">
            <div class="panel-header"><div class="panel-title">재무지표 추이 (최근 8분기)</div></div>
            <canvas id="detailLine" height="120"></canvas>
          </div>
          <div class="panel">
            <div class="panel-header"><div class="panel-title">모델 점수 변화</div></div>
            <canvas id="detailProb" height="120"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    // ======= Demo data generator (TS2000-like financials) =======
    const INDUSTRIES = ["제조", "건설", "서비스", "유통", "IT", "운송", "에너지", "바이오"];
    const rnd = (min, max) => Math.random() * (max - min) + min;
    const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
    const fmtPct = (v) => (v == null ? "—" : (v*100).toFixed(1)+"%");
    const fmt = (v, dig=1) => v==null?"—":Number(v).toFixed(dig);

    let DEMO_MODE = true; // can be toggled in header

    function generateCompany(i) {
      const ind = INDUSTRIES[i % INDUSTRIES.length];
      const baseDebt = rnd(50, 500); // %
      const baseICR = rnd(0.3, 6.5); // interest coverage ratio
      const p = clamp( (baseDebt/1000) + (1/(baseICR+1.5)) + rnd(-0.1,0.1), 0.01, 0.9 );
      return {
        id: "C" + (1000+i),
        name: `기업 ${String.fromCharCode(65 + (i%26))}-${i}`,
        industry: ind,
        debt_ratio: Number(baseDebt.toFixed(1)),
        icr: Number(baseICR.toFixed(2)),
        default_prob: Number((p).toFixed(3)),
        risk: p>0.35?"High":(p>0.18?"Medium":"Low"),
        quarters: Array.from({length: 8}, (_,k)=>({
          q: `Q${8-k}`,
          debt: clamp(baseDebt + rnd(-40,40), 20, 900),
          icr: clamp(baseICR + rnd(-1.2,1.2), 0.1, 9),
          prob: clamp(p + rnd(-0.1,0.1), 0.01, 0.95)
        }))
      };
    }

    function makePortfolio(n=120) { return Array.from({length:n}, (_,i)=>generateCompany(i)); }

    // ======= State =======
    let state = {
      portfolio: makePortfolio(),
      search: "",
      period: "8Q",
      riskFilter: { High:true, Medium:true, Low:false },
      industries: new Set(INDUSTRIES),
      page: 1,
      pageSize: 25,
      sortBy: "default_prob_desc",
      thresholdICR: true,
      thresholdDebt: true,
      smooth: false
    };

    // ======= UI helpers =======
    const qs = (sel)=>document.querySelector(sel);
    const qsa = (sel)=>Array.from(document.querySelectorAll(sel));

    function toast(msg){
      const host = qs('#toast');
      const el = document.createElement('div');
      el.className='item'; el.textContent = msg;
      host.appendChild(el);
      setTimeout(()=>{ el.style.opacity=0; setTimeout(()=>el.remove(), 400); }, 2000);
    }

    function tagRisk(r){
      const cls = r==='High'? 'tag high' : (r==='Medium'? 'tag medium': 'tag low');
      return `<span class="${cls}">${r}</span>`;
    }

    function calcKPIs(rows){
      const n = rows.length;
      const high = rows.filter(r=>r.risk==='High').length;
      const avgProb = rows.reduce((s,r)=>s+r.default_prob,0)/Math.max(1,n);
      const avgICR = rows.reduce((s,r)=>s+r.icr,0)/Math.max(1,n);
      return { n, high, avgProb, avgICR };
    }

    function updateKPIs(rows){
      const {n, high, avgProb, avgICR} = calcKPIs(rows);
      qs('#kpiTotal').textContent = n.toLocaleString();
      qs('#kpiHigh').textContent = high.toLocaleString();
      qs('#kpiAvgProb').textContent = (avgProb*100).toFixed(1)+'%';
      qs('#kpiICR').textContent = avgICR.toFixed(2);
      // Mock deltas
      qs('#kpiTotalDelta').textContent = '▲ 1.2% QoQ'; qs('#kpiTotalDelta').className='delta up';
      qs('#kpiHighDelta').textContent = '▼ 0.7% QoQ'; qs('#kpiHighDelta').className='delta down';
      qs('#kpiAvgProbDelta').textContent = '▲ 0.3% QoQ'; qs('#kpiAvgProbDelta').className='delta up';
      qs('#kpiICRDelta').textContent = '▼ 0.1 QoQ'; qs('#kpiICRDelta').className='delta down';
    }

    // ======= Filters & sorting =======
    function filteredRows(){
      let rows = state.portfolio;
      if(state.search){ rows = rows.filter(r=> r.name.toLowerCase().includes(state.search.toLowerCase())); }
      rows = rows.filter(r=> state.riskFilter[r.risk]);
      rows = rows.filter(r=> state.industries.has(r.industry));
      switch(state.sortBy){
        case 'default_prob_desc': rows = rows.slice().sort((a,b)=>b.default_prob - a.default_prob); break;
        case 'icr_asc': rows = rows.slice().sort((a,b)=>a.icr - b.icr); break;
        case 'debt_desc': rows = rows.slice().sort((a,b)=>b.debt_ratio - a.debt_ratio); break;
        case 'name_asc': rows = rows.slice().sort((a,b)=>a.name.localeCompare(b.name)); break;
      }
      return rows;
    }

    function renderTable(){
      const rows = filteredRows();
      const start = (state.page-1)*state.pageSize;
      const pageRows = rows.slice(start, start+state.pageSize);
      const tbody = qs('#riskTbody');
      tbody.innerHTML = '';
      pageRows.forEach((r, i)=>{
        const tr = document.createElement('tr'); tr.tabIndex=0; tr.setAttribute('role','button');
        tr.innerHTML = `
          <td class="rank">${start + i + 1}</td>
          <td>${r.name}</td>
          <td>${r.industry}</td>
          <td style="text-align:right; color:${r.debt_ratio>400? 'var(--danger)':'inherit'}">${fmt(r.debt_ratio)}</td>
          <td style="text-align:right; color:${r.icr<1? 'var(--danger)':'inherit'}">${fmt(r.icr,2)}</td>
          <td style="text-align:right;">${fmt(r.default_prob*100,1)}</td>
          <td style="text-align:center;">${tagRisk(r.risk)}</td>`;
        tr.addEventListener('click', ()=> openDetail(r));
        tbody.appendChild(tr);
      });
      qs('#tableCount').textContent = rows.length;
      updateKPIs(rows);
      updateAlerts(rows);
    }

    // ======= Charts (overview) =======
    let probLineChart, industryBarChart;

    function buildProbLine(){
      const labels = Array.from({length:8},(_,i)=>`Q${i+1}`);
      const rows = filteredRows();
      const series = labels.map((_,i)=>{
        const s = rows.reduce((acc,r)=>acc + (r.quarters[7-i]?.prob ?? r.default_prob),0);
        return (s / Math.max(1, rows.length))*100;
      });
      const smooth = state.smooth;
      const smoothed = series.map((v,i,arr)=>{
        if(!smooth) return v;
        const window = arr.slice(Math.max(0,i-2), i+1);
        return window.reduce((a,b)=>a+b,0)/window.length;
      });
      const ctx = qs('#probLine');
      if(probLineChart) probLineChart.destroy();
      probLineChart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ label: 'Avg Default Probability', data: smoothed, tension: 0.35, fill: true }] },
        options: {
          plugins: { legend: { display:false } },
          scales: {
            x: { grid: { color: '#1b2330' } },
            y: { grid: { color: '#1b2330' }, ticks: { callback: v=>v+'%' } }
          }
        }
      });
    }

    function buildIndustryBar(){
      const rows = filteredRows();
      const inds = [...state.industries];
      const data = inds.map(ind=>{
        const all = rows.filter(r=>r.industry===ind).length;
        const high = rows.filter(r=>r.industry===ind && r.risk==='High').length;
        return all? (high/all)*100 : 0;
      });
      const ctx = qs('#industryBar');
      if(industryBarChart) industryBarChart.destroy();
      industryBarChart = new Chart(ctx, {
        type: 'bar',
        data: { labels: inds, datasets: [{ label: 'High Risk Share', data }] },
        options: {
          plugins: { legend: { display:false } },
          scales: {
            x: { grid: { color: '#1b2330' } },
            y: { grid: { color: '#1b2330' }, ticks: { callback: v=>v+'%' } }
          }
        }
      });
    }

    // ======= Alerts =======
    function updateAlerts(rows){
      const host = qs('#alertList'); host.innerHTML='';
      const redICR = rows.filter(r=>r.icr<1).slice(0,5);
      const highDebt = rows.filter(r=>r.debt_ratio>400).slice(0,5);
      const highRaise = rows.filter(r=> (r.quarters[7].prob - r.quarters[6].prob) > 0.08).slice(0,5);
      const bullet = (txt)=>{ const li=document.createElement('li'); li.innerHTML=txt; host.appendChild(li); };
      if(qs('#threshICR').checked && redICR.length) bullet(`ICR&lt;1 기업: <strong>${redICR.length}</strong> (예: ${redICR.map(r=>r.name).slice(0,3).join(', ')} …)`);
      if(qs('#threshDebt').checked && highDebt.length) bullet(`부채비율&gt;400% 기업: <strong>${highDebt.length}</strong> (예: ${highDebt.map(r=>r.name).slice(0,3).join(', ')} …)`);
      if(highRaise.length) bullet(`예측 부실확률 급등(>+8%p QoQ): <strong>${highRaise.length}</strong>곳 감지`);
      if(!host.children.length){ const li=document.createElement('li'); li.textContent='현재 규칙 기반 경보 없음'; host.appendChild(li); }
    }

    // ======= Detail Modal =======
    let detailLine, detailProb;
    function openDetail(r){
      qs('#modal').style.display='flex';
      qs('#modalTitle').textContent = `${r.name} · ${r.industry}`;
      const meta = qs('#companyMeta');
      meta.innerHTML = `
        <div class="kpi"><h4>부채비율(%)</h4><div class="val">${fmt(r.debt_ratio)}</div></div>
        <div class="kpi"><h4>이자보상배율</h4><div class="val">${fmt(r.icr,2)}</div></div>
        <div class="kpi"><h4>부실확률</h4><div class="val">${fmt(r.default_prob*100,1)}%</div></div>
        <div class="kpi"><h4>위험등급</h4><div class="val">${tagRisk(r.risk)}</div></div>`;
      const labels = r.quarters.map(q=>q.q).reverse();
      const debt = r.quarters.map(q=>q.debt).reverse();
      const icr = r.quarters.map(q=>q.icr).reverse();
      const prob = r.quarters.map(q=>q.prob*100).reverse();
      if(detailLine) detailLine.destroy();
      detailLine = new Chart(qs('#detailLine'), {
        type:'line', data: { labels, datasets:[{label:'부채비율(%)', data:debt, tension:.35, fill:true}, {label:'ICR', data:icr, yAxisID:'y1', tension:.35}]},
        options:{ plugins:{legend:{display:true}}, scales:{ x:{grid:{color:'#1b2330'}}, y:{grid:{color:'#1b2330'}, position:'left'}, y1:{grid:{display:false}, position:'right'} } }
      });
      if(detailProb) detailProb.destroy();
      detailProb = new Chart(qs('#detailProb'), {
        type:'line', data:{ labels, datasets:[{label:'부실확률(%)', data:prob, tension:.3, fill:true}] },
        options:{ plugins:{legend:{display:false}}, scales:{ x:{grid:{color:'#1b2330'}}, y:{grid:{color:'#1b2330'}, ticks:{callback:v=>v+'%'} } } }
      });
    }
    qs('#closeModal').addEventListener('click', ()=> qs('#modal').style.display='none');
    qs('#modal').addEventListener('click', (e)=>{ if(e.target.id==='modal') qs('#modal').style.display='none'; });

    // ======= Export CSV =======
    function exportCSV(){
      const rows = filteredRows();
      const header = ['corp_id','name','industry','debt_ratio','icr','default_prob','risk'];
      const lines = [header.join(',')].concat(rows.map(r=>[
        r.id, r.name, r.industry, r.debt_ratio, r.icr, r.default_prob, r.risk
      ].join(',')));
      const blob = new Blob(["\ufeff" + lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='ews_portfolio.csv'; a.click();
      URL.revokeObjectURL(url);
      toast('CSV가 다운로드되었습니다.');
    }

    // ======= Industry chips =======
    function renderIndustryChips(){
      const host = qs('#industryChips'); host.innerHTML='';
      INDUSTRIES.forEach(ind=>{
        const el = document.createElement('label'); el.className='chip';
        const ck = document.createElement('input'); ck.type='checkbox'; ck.checked = state.industries.has(ind);
        ck.addEventListener('change', ()=>{ if(ck.checked) state.industries.add(ind); else state.industries.delete(ind); rerender(); });
        el.appendChild(ck); el.append(` ${ind}`);
        host.appendChild(el);
      });
    }

    // ======= Rerender =======
    function rerender(){ renderTable(); buildProbLine(); buildIndustryBar(); }

    // ======= Init =======
    function init(){
      renderIndustryChips();
      // Hook controls
      qs('#search').addEventListener('input', e=>{ state.search = e.target.value.trim(); if(qs('#autoRefresh').checked) rerender(); });
      qs('#period').addEventListener('change', e=>{ state.period = e.target.value; toast('기간이 변경되었습니다. (데모)'); });
      qs('#pageSize').addEventListener('change', e=>{ state.pageSize = parseInt(e.target.value,10); state.page=1; rerender(); });
      qs('#sortBy').addEventListener('change', e=>{ state.sortBy = e.target.value; rerender(); });
      qs('#prevPage').addEventListener('click', ()=>{ state.page = Math.max(1, state.page-1); renderTable(); });
      qs('#nextPage').addEventListener('click', ()=>{ const maxPage = Math.ceil(filteredRows().length/state.pageSize); state.page = Math.min(maxPage, state.page+1); renderTable(); });
      qs('#exportBtn').addEventListener('click', exportCSV);
      qs('#refreshBtn').addEventListener('click', ()=>{ toast('새로고침 완료 (데모 데이터)'); rerender(); });
      qs('#demoToggle').addEventListener('click', ()=>{ DEMO_MODE=!DEMO_MODE; qs('#demoToggle').textContent = DEMO_MODE? '데모데이터 ON' : '데모데이터 OFF'; toast('데모 토글: 실제 API 연동 시 이 스위치를 끄세요.'); });
      qs('#fltHigh').addEventListener('change', e=>{ state.riskFilter.High = e.target.checked; rerender(); });
      qs('#fltMed').addEventListener('change', e=>{ state.riskFilter.Medium = e.target.checked; rerender(); });
      qs('#fltLow').addEventListener('change', e=>{ state.riskFilter.Low = e.target.checked; rerender(); });
      qs('#btnSmooth').addEventListener('click', ()=>{ state.smooth=!state.smooth; rerender(); });

      // First render
      rerender();
    }

    // ======= (Optional) Real API wiring example =======
    async function fetchPortfolioFromAPI(){
      const r = await fetch('/api/portfolio', { headers: { 'Accept': 'application/json' } });
      if (!r.ok) throw new Error(await r.text());
      const data = await r.json();
      state.portfolio = data;   // ← 여기!
      state.page = 1;
      rerender();
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
